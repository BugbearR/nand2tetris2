<!DOCTYPE html>
<html>

<head>
  <title>Folder Access Demo with Persistence</title>
  <style>
    .file-list {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      max-height: 300px;
      overflow-y: auto;
    }

    .file-item {
      padding: 5px;
      border-bottom: 1px solid #eee;
    }

    .permission-needed {
      color: red;
      margin: 10px 0;
      display: none;
    }
  </style>
</head>

<body>
  <h1>Folder Access Demo</h1>
  <button id="selectFolder">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>
  <div id="permissionNeeded" class="permission-needed">
    ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ã€Œãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
  </div>
  <div id="fileList" class="file-list"></div>

  <script>
    let directoryHandle;
    const STORAGE_KEY = 'lastAccessedFolder';

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèª
    window.addEventListener('load', async () => {
      try {
        await loadSavedFolder();
      } catch (error) {
        console.log('ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã¯ã‚ã‚Šã¾ã›ã‚“:', error);
      }
    });

    // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ãƒãƒ³ãƒ‰ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    async function loadSavedFolder() {
      const savedFolder = localStorage.getItem(STORAGE_KEY);
      if (!savedFolder) return;

      try {
        // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ãƒãƒ³ãƒ‰ãƒ«ã‚’å¾©å…ƒ
        directoryHandle = await window.showDirectoryPicker({
          startIn: savedFolder
        });

        // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèª
        const permissionStatus = await directoryHandle.requestPermission({ mode: 'read' });
        if (permissionStatus === 'granted') {
          await listFiles(directoryHandle);
        } else {
          document.getElementById('permissionNeeded').style.display = 'block';
        }
      } catch (error) {
        console.error('ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        localStorage.removeItem(STORAGE_KEY);
      }
    }

    async function selectFolder() {
      try {
        // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        directoryHandle = await window.showDirectoryPicker();

        // é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹ã‚’ä¿å­˜
        try {
          const relativePaths = await directoryHandle.resolve();
          if (relativePaths) {
            const folderPath = relativePaths.join('/');
            localStorage.setItem(STORAGE_KEY, folderPath);
          }
        } catch (error) {
          console.error('ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        }

        // ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('permissionNeeded').style.display = 'none';
        await listFiles(directoryHandle);
      } catch (error) {
        console.error('Error:', error);
        alert('ãƒ•ã‚©ãƒ«ãƒ€ã®é¸æŠä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      }
    }

    async function listFiles(dirHandle, path = '') {
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

      for await (const entry of dirHandle.values()) {
        const itemPath = path ? `${path}/${entry.name}` : entry.name;
        const div = document.createElement('div');
        div.className = 'file-item';

        if (entry.kind === 'file') {
          // ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
          const file = await entry.getFile();
          div.textContent = `ğŸ“„ ${itemPath} (${formatFileSize(file.size)})`;

          // ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ã‚’ä¿å­˜ï¼ˆå¿…è¦ãªå ´åˆï¼‰
          try {
            const relativePaths = await entry.resolve();
            if (relativePaths) {
              const filePath = relativePaths.join('/');
              localStorage.setItem(`file_${entry.name}`, filePath);
            }
          } catch (error) {
            console.error('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          }
        } else if (entry.kind === 'directory') {
          // ãƒ•ã‚©ãƒ«ãƒ€ã®å ´åˆ
          div.textContent = `ğŸ“ ${itemPath}`;
          // ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã‚‚å†å¸°çš„ã«è¡¨ç¤º
          await listFiles(entry, itemPath);
        }

        fileList.appendChild(div);
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    document.getElementById('selectFolder').addEventListener('click', selectFolder);
  </script>
</body>

</html>